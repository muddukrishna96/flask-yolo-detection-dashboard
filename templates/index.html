{% extends "base.html" %}

{% block title %} Dashboard {% endblock %} 

<!-- Element injected in the BODY element -->
{% block body_class %} sidebar-mini {% endblock body_class %} 

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}

  <!-- Google Font: Source Sans Pro -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="/static/assets/plugins/fontawesome-free/css/all.min.css">
  <!-- Ionicons -->
  <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
  <!-- Tempusdominus Bootstrap 4 -->
  <link rel="stylesheet" href="/static/assets/plugins/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css">
  <!-- iCheck -->
  <link rel="stylesheet" href="/static/assets/plugins/icheck-bootstrap/icheck-bootstrap.min.css">
  <!-- JQVMap -->
  <link rel="stylesheet" href="/static/assets/plugins/jqvmap/jqvmap.min.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="/static/assets/css/adminlte.min.css">
  <!-- Custom overrides and color theme -->
  <link rel="stylesheet" href="/static/assets/css/custom.css">
  <!-- Intro.js for guided tours -->
  <link rel="stylesheet" href="https://unpkg.com/intro.js/minified/introjs.min.css">
  <!-- overlayScrollbars -->
  <link rel="stylesheet" href="/static/assets/plugins/overlayScrollbars/css/OverlayScrollbars.min.css">
  <!-- Daterange picker -->
  <link rel="stylesheet" href="/static/assets/plugins/daterangepicker/daterangepicker.css">
  <!-- summernote -->
  <link rel="stylesheet" href="/static/assets/plugins/summernote/summernote-bs4.min.css">

  <!-- Custom styles are in static/assets/css/custom.css -->

{% endblock stylesheets %}

{% block content %}
  
  <div class="content-wrapper">

    <!-- Content Header (Page header) -->
    <div class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1 class="m-0 text-dark">AI results Dashboard</h1>
          </div><!-- /.col -->
          <div class="col-sm-6 text-right">
            <!-- Persistent help button to start tour manually -->
            <button id="tour-help-btn" class="btn btn-sm" title="Take a quick tour">Take Tour</button>
          </div>
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item"><a href="index.html">Home</a></li>
              <li class="breadcrumb-item active">View Detected Image</li>
            </ol>
          </div><!-- /.col -->
        </div><!-- /.row -->
      </div><!-- /.container-fluid -->
    </div>
    <!-- /.content-header -->

    <!-- Small ephemeral toast to remind about the tour (shown if user previously saw tour) -->
    <div id="tour-toast">
      <div class="toast-inner">
        <div class="msg">Need a quick tour?</div>
        <div class="actions">
          <button id="tour-toast-start" class="btn btn-sm btn-primary">Start</button>
          <button id="tour-toast-dismiss" class="btn btn-sm btn-outline-secondary">Dismiss</button>
        </div>
      </div>
    </div>

    <!-- Main content -->
    <section class="content">
      <div class="container-fluid">
        <!-- Small boxes (Stat box) -->
         <div class="row">
       
          <!-- ./col -->
        </div>
        
		<!-- /.row -->
        <!-- Main row -->
        <div class="row">
          <!-- Left col -->
          <section class="col-lg-6 connectedSortable">
            <!-- Custom tabs (Charts with tabs)-->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">
                  <i class="fas fa-chart-pie mr-1"></i>
                  Upload or Stream for AI Processing
                </h3>
				
                
              </div><!-- /.card-header -->
              <div class="card-body">
                <div class="tab-content p-0">
                  <!-- Morris chart - Sales -->
                  <div class="chart tab-pane active" id="revenue-chart"
                        style="position: relative; height: 700px;">
            
			<!-- AI code - LEFT PANEL VISIBLE WORKFLOW -->

			<form id="predict-form" class="form-signin col-lg-12" method="post" enctype="multipart/form-data" name="form1">

  <div style="max-width:100%; margin:auto; text-align:left; padding:12px 8px;">
    <h4 class="h5 mb-2 font-weight-normal">1) Select Model</h4>
    {% if message %}
      <div class="alert alert-warning" role="alert" style="margin-top:8px;">{{ message }}</div>
    {% endif %}

    <!-- Visible list of built-in models as radio buttons (not a dropdown) -->
  <div id="model-list" class="mb-2" style="max-height:140px; overflow:auto; border:1px solid #eee; padding:6px;">
      {% for m in models %}
      <div class="form-check" data-model="{{ m }}">
        <input class="form-check-input" type="radio" name="model" id="model_{{ loop.index }}" value="{{ m }}" {% if selected_model==m %}checked{% endif %}>
        <label class="form-check-label small" for="model_{{ loop.index }}">{{ m }} <span class="model-badge">{{ m[:12] }}</span></label>
      </div>
      {% endfor %}
    </div>

    <div class="mb-3 small text-muted">Or upload a custom .pt model (kept in memory only)</div>
    <div style="border:1px dashed #ddd; padding:8px; border-radius:6px; margin-bottom:8px;">
      <div class="form-row align-items-center">
        <div class="col-6">
          <input type="file" class="form-control-file" id="model_file" accept=".pt">
        </div>
        <div class="col-4">
          <input type="text" class="form-control form-control-sm" id="model_name" placeholder="Display name (optional)">
        </div>
        <div class="col-2">
          <button type="button" id="upload-model-submit" class="btn btn-sm btn-primary">Upload</button>
        </div>
      </div>
      <div class="form-check mt-2">
        <input class="form-check-input" type="checkbox" id="disclaimer_inline">
        <label class="form-check-label small" for="disclaimer_inline">I confirm I have rights to this model</label>
      </div>
    </div>

    <!-- First-time tour prompt (shows only when localStorage flag not set) -->
    <div id="tour-prompt" style="display:none;" role="dialog" aria-hidden="true">
      <div class="tour-prompt-inner">
        <div class="tour-text">Welcome! Would you like a quick tour of the dashboard?</div>
        <div class="tour-actions">
          <button id="tour-start" class="btn btn-sm btn-primary">Start Tour</button>
          <button id="tour-skip" class="btn btn-sm btn-outline-secondary">Skip</button>
        </div>
      </div>
    </div>

    <hr/>

    <h4 class="h5 mb-2 font-weight-normal">2) Choose Input</h4>
    <div class="mb-2">
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="inputType" id="input-image" value="image">
        <label class="form-check-label small" for="input-image">Image</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="inputType" id="input-video" value="video">
        <label class="form-check-label small" for="input-video">Video</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="inputType" id="input-webcam" value="webcam">
        <label class="form-check-label small" for="input-webcam">Webcam</label>
      </div>
    </div>

    <!-- File input (Image/Video) - visible but disabled until relevant option chosen -->
    <div id="file-input-area" class="mb-2">
      <input type="file" name="file" class="form-control-file" id="inputfile" disabled
            accept="image/png,image/jpeg,image/jpg,image/bmp,image/gif,image/webp,video/mp4,video/avi,video/quicktime,video/x-matroska,video/x-flv,video/x-ms-wmv">
    </div>

    <!-- Webcam options - visible but controls disabled until Webcam selected -->
    <div id="webcam-options-area" class="mb-2" style="border:1px solid #f1f1f1; padding:8px; border-radius:6px;">
      <div class="form-group">
        <label class="small">Camera mode</label>
        <div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="camera_mode" id="camera-single" value="single" checked>
            <label class="form-check-label small" for="camera-single">Single</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="camera_mode" id="camera-dual" value="dual">
            <label class="form-check-label small" for="camera-dual">Dual</label>
          </div>
        </div>
      </div>

      <div id="webcam-models-single" style="margin-bottom:6px;">
        <div class="small text-muted">Camera 0 model</div>
        <div style="max-height:100px; overflow:auto; border:1px solid #eee; padding:6px;">
          {% for m in models %}
          <div class="form-check" data-model="{{ m }}">
            <input class="form-check-input" type="radio" name="single_model" id="single_{{ loop.index }}" value="{{ m }}" {% if selected_model==m %}checked{% endif %}>
            <label class="form-check-label small" for="single_{{ loop.index }}">{{ m }} <span class="model-badge">{{ m[:12] }}</span></label>
          </div>
          {% endfor %}
        </div>
      </div>

      <div id="webcam-models-dual" style="display:none;">
        <div class="small text-muted">Camera 0 model</div>
        <div style="max-height:80px; overflow:auto; border:1px solid #eee; padding:6px; margin-bottom:6px;">
          {% for m in models %}
          <div class="form-check" data-model="{{ m }}">
            <input class="form-check-input" type="radio" name="dual_model0" id="d0_{{ loop.index }}" value="{{ m }}" {% if selected_model==m %}checked{% endif %}>
            <label class="form-check-label small" for="d0_{{ loop.index }}">{{ m }} <span class="model-badge">{{ m[:12] }}</span></label>
          </div>
          {% endfor %}
        </div>
        <div class="small text-muted">Camera 1 model</div>
        <div style="max-height:80px; overflow:auto; border:1px solid #eee; padding:6px;">
          {% for m in models %}
          <div class="form-check" data-model="{{ m }}">
            <input class="form-check-input" type="radio" name="dual_model1" id="d1_{{ loop.index }}" value="{{ m }}" {% if selected_model==m %}checked{% endif %}>
            <label class="form-check-label small" for="d1_{{ loop.index }}">{{ m }} <span class="model-badge">{{ m[:12] }}</span></label>
          </div>
          {% endfor %}
        </div>
      </div>

      </div>
      <!-- Sticky action bar so Start/Predict are always visible -->
      <div class="left-actions">
        <div class="d-flex flex-column">
          <button type="button" id="start-webcam-inline" class="btn btn-primary btn-sm mb-2" disabled>Start Webcam</button>
          <button class="btn btn-secondary btn-block" id="predict-btn" type="submit" disabled>Predict</button>
        </div>
      </div>
    </div>

  </div>

  </form>

<!-- AI code - LEFT PANEL END -->

	
	
	

                 
                </div>
              </div><!-- /.card-body -->
            </div>
            <!-- /.card -->

            
      
          </section>
		  
		  
		            <section class="col-lg-6 connectedSortable">
            <!-- Custom tabs (Charts with tabs)-->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">
                  <i class="fas fa-chart-pie mr-1"></i>
                  YOLO Object Detection Results
                </h3>
				
                
              </div><!-- /.card-header -->
              <div class="card-body">
                <div class="tab-content p-0">
                  <!-- Morris chart - Sales -->
                  <div class="chart tab-pane active" id="revenue-chart"
                        style="position: relative; height: 700px;">
            
			<!-- AI code-->



<!-- Result display area (images, video, or webcam stream will be loaded here) -->
<div class="right-result-container" style="width:100%;">
  <!-- For images we reuse the img element. For server-generated video we'll swap in an img streaming from video_feed or an HTML5 video tag if desired. -->
  <img id="result-display" src="" alt="Detection result" style="max-width:100%; height:640px; display: none; object-fit: contain; border:1px solid #ddd;" />
  <img id="video-display" src="" alt="Video result" style="max-width:100%; height:640px; display: none; object-fit: contain; border:1px solid #ddd;" />
  <!-- Loading spinner shown while server is processing -->
  <div id="result-spinner" style="display:none; margin-top:16px;">
    <div class="spinner-border text-primary" role="status" style="width:3rem; height:3rem;">
      <span class="sr-only">Loading...</span>
    </div>
    <div id="spinner-text" style="margin-top:8px; font-weight:500;">Processing, please wait...</div>
  </div>
  <div style="margin-top:8px; text-align:center;">
    <button id="stop-btn" class="btn btn-danger btn-sm" style="display:none;">Close</button>
  </div>
</div>

<script>
// Show uploaded/processed image if provided by server
// server-provided processed image URL (empty string if none)
var server_image_url = {{ (image_url if image_url else '')|tojson }};
var server_video_present = {{ ('true' if video_present else 'false')|tojson }} === 'true';
var server_video_folder = {{ (video_folder if video_folder else '')|tojson }};
var server_video_stream_url = {{ (server_video_stream_url if server_video_stream_url else '')|tojson }};
function showUploadedResult() {
  if (server_image_url) {
    var img = document.getElementById('result-display');
    img.src = server_image_url;
    img.style.display = 'block';
    document.getElementById('stop-btn').style.display = 'inline-block';
    // hide spinner once result is ready
    var spinner = document.getElementById('result-spinner');
    if (spinner) spinner.style.display = 'none';
  }
  else if (server_video_present) {
    // show server-processed video: set src to video_feed with folder param so it reads the right file
    var vimg = document.getElementById('video-display');
    var feedUrl = "{{ url_for('video_feed') }}" + (server_video_folder ? "?folder=" + server_video_folder : "");
    vimg.src = feedUrl;
    vimg.style.display = 'block';
    document.getElementById('stop-btn').style.display = 'inline-block';
    var spinner = document.getElementById('result-spinner');
    if (spinner) spinner.style.display = 'none';
  }
  else if (server_video_stream_url) {
    // Show server-processed MJPEG stream for uploaded video (per-frame processing)
    var vimg = document.getElementById('video-display');
    vimg.src = server_video_stream_url;
    vimg.style.display = 'block';
    document.getElementById('stop-btn').style.display = 'inline-block';
    var spinner = document.getElementById('result-spinner');
    if (spinner) spinner.style.display = 'none';
  }
}

// Show webcam configuration modal
function showWebcamModal() {
  // For inline workflow: select webcam input and pre-select models from main selection (if any)
  var sel = document.querySelector('input[name="model"]:checked');
  var selectedModel = sel ? sel.value : 'yolov8n.pt';

  // Pre-select single/dual model radios to the chosen model where possible
  var singleRadio = document.querySelector('input[name="single_model"][value="' + selectedModel + '"]');
  if (singleRadio) singleRadio.checked = true;
  var d0 = document.querySelector('input[name="dual_model0"][value="' + selectedModel + '"]');
  if (d0) d0.checked = true;
  var d1 = document.querySelector('input[name="dual_model1"][value="' + selectedModel + '"]');
  if (d1) d1.checked = true;

  // Switch the inputType to webcam so webcam options become enabled
  var wb = document.getElementById('input-webcam');
  if (wb) { wb.checked = true; wb.dispatchEvent(new Event('change')); }

  // Scroll to webcam area for visibility
  var el = document.getElementById('webcam-options-area');
  if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

// Toggle dual camera options visibility
function toggleDualCameraOptions() {
  // Support legacy call and inline radio-driven mode.
  var modeRadio = document.querySelector('input[name="camera_mode"]:checked');
  var mode = modeRadio ? modeRadio.value : null;
  if (!mode) {
    // legacy fallback to select element
    var sel = document.getElementById('camera-mode-select');
    mode = sel ? sel.value : 'single';
  }
  if (mode === 'single') {
    var s = document.getElementById('webcam-models-single'); if (s) s.style.display = 'block';
    var d = document.getElementById('webcam-models-dual'); if (d) d.style.display = 'none';
  } else {
    var s2 = document.getElementById('webcam-models-single'); if (s2) s2.style.display = 'none';
    var d2 = document.getElementById('webcam-models-dual'); if (d2) d2.style.display = 'block';
  }
  // Enable the Start Webcam button if webcam input is selected
  var inputTypeWebcam = document.getElementById('input-webcam');
  if (inputTypeWebcam && inputTypeWebcam.checked) {
    var startBtn = document.getElementById('start-webcam-inline');
    if (startBtn) {
      startBtn.disabled = false;
      // ensure the button is visible inside the left panel (scroll to it)
      try { startBtn.scrollIntoView({ behavior: 'smooth', block: 'center' }); } catch(e){}
      // give a small attention highlight
      startBtn.style.boxShadow = '0 0 0.5rem rgba(220,53,69,0.25)';
      setTimeout(function(){ startBtn.style.boxShadow = ''; }, 1200);
    }
  }
}

// Start webcam based on selected configuration
function startSelectedWebcam() {
  // Read camera mode from radios (inline UI) or fallback to old select
  var modeRadio = document.querySelector('input[name="camera_mode"]:checked');
  var mode = modeRadio ? modeRadio.value : (document.getElementById('camera-mode-select') ? document.getElementById('camera-mode-select').value : 'single');
  var vimg = document.getElementById('video-display');
  var img = document.getElementById('result-display');
  var spinner = document.getElementById('result-spinner');
  var spinnerText = document.getElementById('spinner-text');

  // Do not rely on modal; just show spinner in the result area
  if (img) img.style.display = 'none';
  if (vimg) vimg.style.display = 'none';
  if (spinner) {
    spinner.style.display = 'block';
    if (spinnerText) {
      spinnerText.textContent = mode === 'single' ? 'Initializing camera and loading model...' : 'Initializing cameras and loading models...';
    }
  }

  // Set up the webcam stream URL based on selected inline radio models
  if (mode === 'single') {
    var selModel = document.querySelector('input[name="single_model"]:checked');
    var model = selModel ? selModel.value : 'yolov8n.pt';
    vimg.src = "{{ url_for('webcam_feed') }}?model=" + encodeURIComponent(model);
  } else {
    var m0 = document.querySelector('input[name="dual_model0"]:checked');
    var m1 = document.querySelector('input[name="dual_model1"]:checked');
    var model0 = m0 ? m0.value : 'yolov8n.pt';
    var model1 = m1 ? m1.value : 'yolov8n.pt';
    vimg.src = "{{ url_for('webcam_feed_dual') }}?model0=" + encodeURIComponent(model0) + "&model1=" + encodeURIComponent(model1);
  }
  
  // Show video display and hide spinner once stream starts loading
  vimg.onload = function() {
    if (spinner) spinner.style.display = 'none';
    vimg.style.display = 'block';
    document.getElementById('stop-btn').style.display = 'inline-block';
  };
  
  // For MJPEG streams, onload may not fire, so use a timeout fallback
  setTimeout(function() {
    if (spinner && spinner.style.display !== 'none') {
      spinner.style.display = 'none';
      vimg.style.display = 'block';
      document.getElementById('stop-btn').style.display = 'inline-block';
    }
  }, 5000); // Show video after 5 seconds to account for model loading + camera init
}

// Start webcam stream into the result area (kept for backward compatibility)
function startWebcam() {
  showWebcamModal();
}

// Stop any stream and clear the result area (works for image, processed video or webcam)
function stopStream() {
  var img = document.getElementById('result-display');
  var vimg = document.getElementById('video-display');
  var spinner = document.getElementById('result-spinner');
  var spinnerText = document.getElementById('spinner-text');
  
  // Clearing src should close MJPEG connections in most browsers
  try { img.src = ''; } catch(e) {}
  try { vimg.src = ''; } catch(e) {}
  img.style.display = 'none';
  vimg.style.display = 'none';
  document.getElementById('stop-btn').style.display = 'none';
  
  // Hide spinner and reset text
  if (spinner) spinner.style.display = 'none';
  if (spinnerText) spinnerText.textContent = 'Processing, please wait...';
}

document.getElementById('stop-btn').addEventListener('click', function(e){
  stopStream();
  // Optionally navigate back to top/home
  window.scrollTo({ top: 0, behavior: 'smooth' });
});

// If the server provided a processed image path, show it on load
window.addEventListener('load', function(){
  showUploadedResult();
});

// Show spinner when user submits the predict form
document.getElementById('predict-form').addEventListener('submit', function(e){
  // clear previous results
  try { document.getElementById('result-display').src = ''; } catch(e) {}
  try { document.getElementById('video-display').src = ''; } catch(e) {}
  document.getElementById('result-display').style.display = 'none';
  document.getElementById('video-display').style.display = 'none';
  // show spinner
  var spinner = document.getElementById('result-spinner');
  if (spinner) spinner.style.display = 'block';
});

// Inline UI wiring: enable/disable controls based on selections
(function(){
  // inputType radios
  var inputRadios = document.querySelectorAll('input[name="inputType"]');
  inputRadios.forEach(function(r){ r.addEventListener('change', function(){
    var val = document.querySelector('input[name="inputType"]:checked').value;
    if (val === 'image' || val === 'video'){
      document.getElementById('inputfile').disabled = false;
      document.getElementById('predict-btn').disabled = true; // enabled when file selected
      document.getElementById('start-webcam-inline').disabled = true;
    } else if (val === 'webcam'){
      document.getElementById('inputfile').disabled = true;
      document.getElementById('inputfile').value = '';
      document.getElementById('predict-btn').disabled = true;
      document.getElementById('start-webcam-inline').disabled = false;
    }
  }); });

  // file input change -> enable Predict
  var fileInput = document.getElementById('inputfile');
    if (fileInput){
    fileInput.addEventListener('change', function(){
      var btn = document.getElementById('predict-btn');
      if (this.files && this.files.length > 0){ 
        btn.disabled = false; 
        // Make the button visually prominent when enabled
        btn.classList.remove('btn-secondary');
        btn.classList.add('btn-danger');
        btn.textContent = 'Detect';
        // bring button into view
        try { btn.scrollIntoView({behavior:'smooth', block:'center'}); } catch(e){}
      }
      else { 
        btn.disabled = true; 
        btn.classList.remove('btn-danger');
        btn.classList.add('btn-secondary');
        btn.textContent = 'Predict';
      }
    });
  }

  // camera mode change -> show/hide dual panels
  var camRadios = document.querySelectorAll('input[name="camera_mode"]');
  camRadios.forEach(function(r){ r.addEventListener('change', function(){ toggleDualCameraOptions(); }); });

  // Upload model button handler (AJAX)
  var uploadBtn = document.getElementById('upload-model-submit');
  if (uploadBtn){
    uploadBtn.addEventListener('click', function(){
      if(!document.getElementById('disclaimer_inline').checked){ alert('Please confirm you have the rights to upload this model.'); return; }
      var file = document.getElementById('model_file');
      if(!file || !file.files || file.files.length===0){ alert('Please select a .pt model file to upload.'); return; }
      var fd = new FormData();
      fd.append('model_file', file.files[0]);
      fd.append('model_name', document.getElementById('model_name').value || '');
      fd.append('disclaimer', document.getElementById('disclaimer_inline').checked ? 'on' : '');
      uploadBtn.disabled = true; uploadBtn.textContent = 'Uploading...';
      fetch('/upload_model', { method: 'POST', body: fd }).then(function(r){ return r.text(); }).then(function(){ location.reload(); }).catch(function(err){ alert('Upload failed: '+err); uploadBtn.disabled=false; uploadBtn.textContent='Upload'; });
    });
  }
  // Wire Start Webcam inline button to existing startSelectedWebcam function
  var startInline = document.getElementById('start-webcam-inline');
  if (startInline) startInline.addEventListener('click', function(){ startSelectedWebcam(); });

})();
</script>


<!-- AI code ends here-->		

                    </div>
                 
                </div>
              </div><!-- /.card-body -->
            </div>
            <!-- /.card -->

            
      
          </section>
		  
		  
		  
          <!-- /.Left col -->
          <!-- right col (We are only adding the ID to make the widgets sortable)-->

          <!-- right col -->
        </div>
        <!-- /.row (main row) -->
      </div><!-- /.container-fluid -->
    </section>
    <!-- /.content -->

  </div>

{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}

  <!-- jQuery -->
  <script src="/static/assets/plugins/jquery/jquery.min.js"></script>
  <!-- jQuery UI 1.11.4 -->
  <script src="/static/assets/plugins/jquery-ui/jquery-ui.min.js"></script>
  <!-- Resolve conflict in jQuery UI tooltip with Bootstrap tooltip -->
  <script>
    $.widget.bridge('uibutton', $.ui.button)
  </script>
  <!-- Bootstrap 4 -->
  <script src="/static/assets/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
  <!-- ChartJS -->
  <script src="/static/assets/plugins/chart.js/Chart.min.js"></script>
  <!-- Sparkline -->
  <script src="/static/assets/plugins/sparklines/sparkline.js"></script>
  <!-- JQVMap -->
  <script src="/static/assets/plugins/jqvmap/jquery.vmap.min.js"></script>
  <script src="/static/assets/plugins/jqvmap/maps/jquery.vmap.usa.js"></script>
  <!-- jQuery Knob Chart -->
  <script src="/static/assets/plugins/jquery-knob/jquery.knob.min.js"></script>
  <!-- daterangepicker -->
  <script src="/static/assets/plugins/moment/moment.min.js"></script>
  <script src="/static/assets/plugins/daterangepicker/daterangepicker.js"></script>
  <!-- Tempusdominus Bootstrap 4 -->
  <script src="/static/assets/plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js"></script>
  <!-- Summernote -->
  <script src="/static/assets/plugins/summernote/summernote-bs4.min.js"></script>
  <!-- overlayScrollbars -->
  <script src="/static/assets/plugins/overlayScrollbars/js/jquery.overlayScrollbars.min.js"></script>
  <!-- AdminLTE App -->
  <script src="/static/assets/js/adminlte.js"></script>
  <!-- AdminLTE dashboard demo (This is only for demo purposes) -->
  <script src="/static/assets/js/pages/dashboard.js"></script>
  <!-- AdminLTE for demo purposes -->
  <script src="/static/assets/js/demo.js"></script>
  <!-- Intro.js library -->
  <script src="https://unpkg.com/intro.js/minified/intro.min.js"></script>

  <script>
    // Guided tour: show prompt if user hasn't seen the tour or if forced by URL (?tour=1)
    (function(){
      function onReady(fn){ if (document.readyState !== 'loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
      onReady(function(){
        try {
          var seen = localStorage.getItem('dashboard_tour_seen');
          var prompt = document.getElementById('tour-prompt');
          var startBtn = document.getElementById('tour-start');
          var skipBtn = document.getElementById('tour-skip');
          var helpBtn = document.getElementById('tour-help-btn');
          var toast = document.getElementById('tour-toast');
          var toastStart = document.getElementById('tour-toast-start');
          var toastDismiss = document.getElementById('tour-toast-dismiss');

          // check URL param 'tour=1' to force display
          var urlParams = new URLSearchParams(window.location.search);
          var force = urlParams.get('tour') === '1';

          if ((!seen && prompt) || force){
            // show prompt after short delay
            setTimeout(function(){ if (prompt) prompt.style.display = 'block'; }, 500);
          } else if (seen && !localStorage.getItem('dashboard_tour_skipped')){
            // user previously saw tour — show a gentle toast reminder for a short time
            if (toast){ toast.style.display = 'block'; setTimeout(function(){ try{ toast.style.display='none'; }catch(e){} }, 15000); }
          }

          function markSeen(){ localStorage.setItem('dashboard_tour_seen', '1'); if (prompt) prompt.style.display='none'; }

          function startTour(){
            markSeen();
            var candidateSteps = [
              { selector: '#model-list', text: 'Step 1: Choose a model from the visible list or upload a custom .pt model.', position: 'bottom' },
              { selector: '#model_file', text: 'You can upload a custom .pt model here (it is loaded into memory only).', position: 'bottom' },
              { selector: '#input-image', text: 'Step 2: Select the input type: Image, Video, or Webcam.', position: 'bottom' },
              { selector: '#file-input-area', text: 'If you selected Image or Video, pick a file here and press predict buttom.', position: 'bottom' },
              { selector: '#webcam-options-area', text: 'If Webcam is selected, choose single or dual camera and per-camera models here.', position: 'bottom' },
              { selector: '#start-webcam-inline', text: 'Start the webcam stream inline on the right side.', position: 'bottom' },
              { selector: '#predict-btn', text: 'Click Detect to run the selected model on the uploaded file.', position: 'bottom' },
              { selector: '#result-display', text: 'Results (images/videos/streams) show here on the right.', position: 'top' }
            ];

            var steps = [];
            candidateSteps.forEach(function(s){
              try {
                var el = document.querySelector(s.selector);
                // If element exists but is hidden (display:none), try to use a visible right-side container
                var isVisible = el && el.offsetParent !== null && window.getComputedStyle(el).display !== 'none' && window.getComputedStyle(el).visibility !== 'hidden';
                if (el && isVisible) {
                  steps.push({ element: el, intro: s.text, position: s.position });
                } else if (s.selector === '#result-display') {
                  // prefer the right-result container as anchor for the results step
                  var alt = document.querySelector('.right-result-container');
                  if (alt) {
                    steps.push({ element: alt, intro: s.text, position: 'left' });
                  } else {
                    steps.push({ intro: s.text });
                  }
                } else if (el && !isVisible) {
                  // element present but hidden: show a center step instead so the user still sees guidance
                  steps.push({ intro: s.text });
                } else {
                  // element not present: add a center step showing the text so the flow continues
                  steps.push({ intro: s.text });
                }
              } catch(e){ steps.push({ intro: s.text }); }
            });

            // Hide the built-in skip button and label — we provide our own prompt controls
            introJs().setOptions({ steps: steps, showProgress: true, exitOnOverlayClick: false, showBullets: false, nextLabel:'Next', prevLabel:'Back', doneLabel:'Done', skipLabel:'', showSkipButton: false }).start();
          }

          if (startBtn){ startBtn.addEventListener('click', startTour); }
          if (skipBtn){ skipBtn.addEventListener('click', markSeen); }
          if (helpBtn){ helpBtn.addEventListener('click', function(){ startTour(); }); }
          if (toastStart){ toastStart.addEventListener('click', function(){ startTour(); if (toast) toast.style.display='none'; }); }
          if (toastDismiss){ toastDismiss.addEventListener('click', function(){ if (toast) toast.style.display='none'; localStorage.setItem('dashboard_tour_skipped','1'); }); }
        } catch (e){ console.warn('Tour init failed', e); }
      });
    })();
  </script>

{% endblock javascripts %}
