{% extends "base.html" %}

{% block title %} Dashboard {% endblock %} 

<!-- Element injected in the BODY element -->
{% block body_class %} sidebar-mini {% endblock body_class %} 

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}

  <!-- Google Font: Source Sans Pro -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="/static/assets/plugins/fontawesome-free/css/all.min.css">
  <!-- Ionicons -->
  <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
  <!-- Tempusdominus Bootstrap 4 -->
  <link rel="stylesheet" href="/static/assets/plugins/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css">
  <!-- iCheck -->
  <link rel="stylesheet" href="/static/assets/plugins/icheck-bootstrap/icheck-bootstrap.min.css">
  <!-- JQVMap -->
  <link rel="stylesheet" href="/static/assets/plugins/jqvmap/jqvmap.min.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="/static/assets/css/adminlte.min.css">
  <!-- Custom overrides and color theme -->
  <link rel="stylesheet" href="/static/assets/css/custom.css">
  <!-- Intro.js for guided tours -->
  <link rel="stylesheet" href="https://unpkg.com/intro.js/minified/introjs.min.css">
  <!-- overlayScrollbars -->
  <link rel="stylesheet" href="/static/assets/plugins/overlayScrollbars/css/OverlayScrollbars.min.css">
  <!-- Daterange picker -->
  <link rel="stylesheet" href="/static/assets/plugins/daterangepicker/daterangepicker.css">
  <!-- summernote -->
  <link rel="stylesheet" href="/static/assets/plugins/summernote/summernote-bs4.min.css">

  <!-- Custom styles are in static/assets/css/custom.css -->

{% endblock stylesheets %}

{% block content %}
  
  <div class="content-wrapper">

    <!-- Home view: shown on initial load -->
    <div id="home-view" style="display:block; padding:60px 0; text-align:center;">
      <img src="/static/assets/logo.png" alt="Logo" style="width:320px; max-width:80%; height:auto; display:block; margin:0 auto 18px;">
      <h2 style="font-weight:600; color:#333;">Welcome to the AI Dashboard</h2>
      <p class="text-muted">Select a task from the sidebar to get started.</p>
      <div style="max-width:900px; margin:18px auto 0; text-align:left;">
        <h4 style="font-weight:600; color:#4f7382;">Vision</h4>
        <p style="color:#333; font-size:1rem; line-height:1.4;">Our vision is to create a free, open-source, and universally accessible inference dashboard that streamlines the way computer vision teams develop, test, and validate their models. We aim to eliminate unnecessary complexity, reduce engineering overhead, and accelerate innovation by providing a unified platform where users can effortlessly upload, run, and compare models across multiple input sources ,images, videos, single or multi-camera feeds in real time.</p>
        <p style="color:#555; font-size:0.95rem; margin-top:8px;">This platform provides tooling and a common UI for experimentation and validation. It is not intended to claim ownership of third-party model weights: the models available for users are provided by their respective authors (for example, Ultralytics) and remain those authors' property.</p>
        <!-- Important phase note -->
        <div class="alert alert-warning" role="alert" style="margin-top:14px; border-left:4px solid #d39e00; background:#fff3cd; color:#856404;">
          <h5 style="margin-top:0; margin-bottom:6px; font-weight:600;">Important</h5>
          <p style="margin:0; line-height:1.4;">This dashboard is currently under construction and features are rolled out in phases. Phase 1 supports only YOLO models v8 and above in <code>.pt</code> format as officially supported inputs. Other model formats or versions may be uploaded, but results could be unreliable or unexpected. Please treat this platform as a development/testing tool and verify results carefully.</p>
        </div>
      </div>
    </div>

    <!-- Contact page view: replaces the modal when user clicks Contact in the top nav -->
    <div id="contact-view" style="display:none; padding:40px 0; text-align:center;">
      <div style="max-width:720px; margin:0 auto; text-align:left;">
        <div class="card">
          <div class="card-body d-flex align-items-start">
            <img src="/static/assets/photo.jpg" alt="Photo" style="width:96px; height:96px; object-fit:cover; margin-right:16px;" class="rounded-circle">
            <div>
              <h3 style="margin:0 0 6px 0;">muddu krishna galavalli</h3>
              <p style="margin:0 0 6px 0; color:#666;">AI / Computer Vision</p>
              <p style="margin:6px 0;"><strong>Phone:</strong> <a href="tel:+4915906133210">+49 15906133210</a></p>
              <p style="margin:6px 0;"><strong>Email:</strong> <a href="mailto:galavallimuddukrishna@gmail.com">galavallimuddukrishna@gmail.com</a></p>
              <p style="margin:6px 0;">Links:
                <a href="https://www.linkedin.com/in/galavalli-muddu-krishna-bb87ba112/" target="_blank" rel="noopener" class="ml-2"><i class="fab fa-linkedin"></i> LinkedIn</a>
                <a href="https://github.com/muddukrishna96" target="_blank" rel="noopener" class="ml-3"><i class="fab fa-github"></i> GitHub</a>
              </p>
              <!-- Brief introduction / bio -->
              <div style="margin-top:12px; color:#333;">
                <h5 style="margin:8px 0 6px 0;">Brief Introduction</h5>
                <p style="margin:0; line-height:1.45; font-size:0.95rem;">I am Muddu Krishna Galavalli, an AI Specialist with over three years of professional experience in machine learning, computer vision, and end-to-end AI engineering. I have a strong track record of delivering scalable, real-time inspection and automation solutions across the automotive, aerospace, and medical industries. My expertise spans designing and deploying advanced computer vision pipelines, leading cross-functional engineering teams, and managing full AI project lifecycles from large-scale data collection and annotation to model training, evaluation, and cloud deployment.</p>
                <p style="margin:8px 0 0 0; line-height:1.45; font-size:0.95rem;">I bring a rare combination of deep technical expertise and strong project leadership. I&rsquo;ve architected multi-camera, real-time inspection systems that process over 3,000 units a day, delivered cloud-based inference pipelines with sub-2-second latency, and achieved industry-leading accuracy on mission-critical tasks like surgical screw identification and quality control automation. My work consistently bridges the gap between research and real-world deployment, ensuring AI systems are not just cutting-edge but reliable, scalable, and factory-ready.</p>
                <p style="margin:8px 0 0 0; line-height:1.45; font-size:0.95rem;">I excel in fast-paced environments where innovation meets execution, and I&rsquo;m passionate about building intelligent vision systems that redefine operational performance. If your team needs someone who can own the entire ML lifecycle, align stakeholders, and deliver solutions that work where it matters in production — I&rsquo;m the person who makes it happen.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Detection dashboard: hidden until user selects Object detection task -->
    <div id="detection-dashboard" style="display:none;">

      <!-- Message shown when a selected task is not yet implemented -->
      <div id="task-unavailable" style="display:none; padding:60px 0; text-align:center;">
        <div class="card mx-auto" style="max-width:720px;">
          <div class="card-body">
            <h4 class="card-title">Feature coming soon</h4>
            <p class="card-text">The <strong id="unavailable-task-name">selected</strong> feature is under development and will be available in a future release. For now, only the Object detection dashboard is available.</p>
            <button id="unavailable-ok" class="btn btn-primary">OK</button>
          </div>
        </div>
      </div>

      <div id="detection-content">

    <!-- Content Header (Page header) -->
    <div class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1 class="m-0 text-dark">AI results Dashboard</h1>
          </div><!-- /.col -->
          <div class="col-sm-6 text-right">
            <!-- Persistent help button to start tour manually -->
            <button id="tour-help-btn" class="btn btn-sm" title="Take a quick tour">Take Tour</button>
          </div>
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item"><a href="index.html">Home</a></li>
              <li class="breadcrumb-item active">View Detected Image</li>
            </ol>
          </div><!-- /.col -->
        </div><!-- /.row -->
      </div><!-- /.container-fluid -->
    </div>
    <!-- /.content-header -->

    <!-- Small ephemeral toast to remind about the tour (shown if user previously saw tour) -->
    <div id="tour-toast">
      <div class="toast-inner">
        <div class="msg">Need a quick tour?</div>
        <div class="actions">
          <button id="tour-toast-start" class="btn btn-sm btn-primary">Start</button>
          <button id="tour-toast-dismiss" class="btn btn-sm btn-outline-secondary">Dismiss</button>
        </div>
      </div>
    </div>

    <!-- Main content -->
    <section class="content">
      <div class="container-fluid">
        <!-- Small boxes (Stat box) -->
         <div class="row">
       
          <!-- ./col -->
        </div>
        
		<!-- /.row -->
        <!-- Main row -->
        <div class="row">
          <!-- Left col -->
          <section class="col-lg-6 connectedSortable">
            <!-- Custom tabs (Charts with tabs)-->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">
                  <i class="fas fa-chart-pie mr-1"></i>
                  Upload or Stream for AI Processing
                </h3>
				
                
              </div><!-- /.card-header -->
              <div class="card-body">
                <div class="tab-content p-0">
                  <!-- Morris chart - Sales -->
                  <div class="chart tab-pane active" id="revenue-chart"
                        style="position: relative; height: 700px;">
            
			<!-- AI code - LEFT PANEL VISIBLE WORKFLOW -->

			<form id="predict-form" class="form-signin col-lg-12" method="post" enctype="multipart/form-data" name="form1">

  <div style="max-width:100%; margin:auto; text-align:left; padding:12px 8px;">
    <h4 class="h5 mb-2 font-weight-normal">1) Select Model</h4>
    {% if message %}
      <div class="alert alert-warning" role="alert" style="margin-top:8px;">{{ message }}</div>
    {% endif %}

    <!-- Visible list of built-in models as radio buttons (not a dropdown) -->
  <div id="model-list" class="mb-2" style="max-height:140px; overflow:auto; border:1px solid #eee; padding:6px;">
      {% for m in models %}
      <div class="form-check" data-model="{{ m }}">
        <input class="form-check-input" type="radio" name="model" id="model_{{ loop.index }}" value="{{ m }}" {% if selected_model==m %}checked{% endif %}>
        <label class="form-check-label small" for="model_{{ loop.index }}">{{ m }} <span class="model-badge">{{ m[:12] }}</span></label>
      </div>
      {% endfor %}
    </div>

    <div class="mb-3 small text-muted">Or upload a custom .pt model (kept in memory only)</div>
    <div style="border:1px dashed #ddd; padding:8px; border-radius:6px; margin-bottom:8px;">
      <div class="form-row align-items-center">
        <div class="col-6">
          <input type="file" class="form-control-file" id="model_file" accept=".pt">
        </div>
        <div class="col-4">
          <input type="text" class="form-control form-control-sm" id="model_name" placeholder="Display name (optional)">
        </div>
        <div class="col-2">
          <button type="button" id="upload-model-submit" class="btn btn-sm btn-primary">Upload</button>
        </div>
      </div>
      <div class="form-check mt-2">
        <input class="form-check-input" type="checkbox" id="disclaimer_inline">
        <label class="form-check-label small" for="disclaimer_inline">I confirm I have rights to this model</label>
      </div>
    </div>

    <!-- First-time tour prompt (shows only when localStorage flag not set) -->
    <div id="tour-prompt" style="display:none;" role="dialog" aria-hidden="true">
      <div class="tour-prompt-inner">
        <div class="tour-text">Welcome! Would you like a quick tour of the dashboard?</div>
        <div class="tour-actions">
          <button id="tour-start" class="btn btn-sm btn-primary">Start Tour</button>
          <button id="tour-skip" class="btn btn-sm btn-outline-secondary">Skip</button>
        </div>
      </div>
    </div>

    <hr/>

    <h4 class="h5 mb-2 font-weight-normal">2) Choose Input</h4>
    <div class="mb-2">
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="inputType" id="input-image" value="image">
        <label class="form-check-label small" for="input-image">Image</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="inputType" id="input-video" value="video">
        <label class="form-check-label small" for="input-video">Video</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="inputType" id="input-webcam" value="webcam">
        <label class="form-check-label small" for="input-webcam">Webcam</label>
      </div>
    </div>

    <!-- File input (Image/Video) - visible but disabled until relevant option chosen -->
    <div id="file-input-area" class="mb-2">
      <input type="file" name="file" class="form-control-file" id="inputfile" disabled
            accept="image/png,image/jpeg,image/jpg,image/bmp,image/gif,image/webp,video/mp4,video/avi,video/quicktime,video/x-matroska,video/x-flv,video/x-ms-wmv">
    </div>

    <!-- Webcam options - visible but controls disabled until Webcam selected -->
    <div id="webcam-options-area" class="mb-2" style="border:1px solid #f1f1f1; padding:8px; border-radius:6px;">
      <div class="form-group">
        <label class="small">Camera mode</label>
        <div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="camera_mode" id="camera-single" value="single" checked>
            <label class="form-check-label small" for="camera-single">Single</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="camera_mode" id="camera-dual" value="dual">
            <label class="form-check-label small" for="camera-dual">Dual</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="single_split_mode" />
            <label class="form-check-label small" for="single_split_mode">Process single camera with two models (stacked)</label>
          </div>
        </div>
      </div>

      <div id="webcam-models-single" style="margin-bottom:6px;">
        <div class="small text-muted">Camera 0 model</div>
        <div style="max-height:100px; overflow:auto; border:1px solid #eee; padding:6px;">
          {% for m in models %}
          <div class="form-check" data-model="{{ m }}">
            <input class="form-check-input" type="radio" name="single_model" id="single_{{ loop.index }}" value="{{ m }}" {% if selected_model==m %}checked{% endif %}>
            <label class="form-check-label small" for="single_{{ loop.index }}">{{ m }} <span class="model-badge">{{ m[:12] }}</span></label>
          </div>
          {% endfor %}
        </div>
      </div>

      <div id="webcam-models-dual" style="display:none;">
        <div class="small text-muted">Camera 0 model</div>
        <div style="max-height:80px; overflow:auto; border:1px solid #eee; padding:6px; margin-bottom:6px;">
          {% for m in models %}
          <div class="form-check" data-model="{{ m }}">
            <input class="form-check-input" type="radio" name="dual_model0" id="d0_{{ loop.index }}" value="{{ m }}" {% if selected_model==m %}checked{% endif %}>
            <label class="form-check-label small" for="d0_{{ loop.index }}">{{ m }} <span class="model-badge">{{ m[:12] }}</span></label>
          </div>
          {% endfor %}
        </div>
        <div class="small text-muted">Camera 1 model</div>
        <div style="max-height:80px; overflow:auto; border:1px solid #eee; padding:6px;">
          {% for m in models %}
          <div class="form-check" data-model="{{ m }}">
            <input class="form-check-input" type="radio" name="dual_model1" id="d1_{{ loop.index }}" value="{{ m }}" {% if selected_model==m %}checked{% endif %}>
            <label class="form-check-label small" for="d1_{{ loop.index }}">{{ m }} <span class="model-badge">{{ m[:12] }}</span></label>
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- Camera index selection modal (used when multiple cameras detected) -->
      <div id="camera-index-modal" class="modal" tabindex="-1" role="dialog" style="display:none;">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Select Camera</h5>
            </div>
            <div class="modal-body" id="camera-index-body">
              <p>Multiple cameras detected. Choose which camera to use:</p>
              <div id="camera-index-list"></div>
            </div>
            <div class="modal-footer">
              <button type="button" id="camera-index-choose" class="btn btn-primary">Use selected</button>
              <button type="button" id="camera-index-cancel" class="btn btn-secondary">Cancel</button>
            </div>
          </div>
        </div>
      </div>

          <!-- Contact modal -->
          <div id="contact-modal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-sm" role="document">
              <div class="modal-content">
                <div class="modal-header d-flex align-items-center">
                  <img src="/static/assets/photo.jpg" alt="Photo" style="width:64px; height:64px; object-fit:cover; margin-right:12px;" class="rounded-circle">
                  <div style="flex:1 1 auto;">
                    <h5 class="modal-title mb-0">muddu krishna galavalli</h5>
                    <small class="text-muted">AI / Computer Vision</small>
                  </div>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <p><strong>Phone:</strong> <a href="tel:+49 15906133210">+49 15906133210</a></p>
                  <p class="mb-1"><strong>Links:</strong></p>
                  <p>
                    <a href="https://www.linkedin.com/in/galavalli-muddu-krishna-bb87ba112/" target="_blank" rel="noopener" class="mr-2"><i class="fab fa-linkedin fa-lg"></i> LinkedIn</a>
                    <a href="https://github.com/muddukrishna96?tab=repositories" target="_blank" rel="noopener"><i class="fab fa-github fa-lg"></i> GitHub</a>
                  </p>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
              </div>
            </div>
          </div>

      </div>
      <!-- Sticky action bar so Start/Predict are always visible -->
      <div class="left-actions">
        <div class="d-flex flex-column">
          <button type="button" id="start-webcam-inline" class="btn btn-primary btn-sm mb-2" disabled>Start Webcam</button>
          <button class="btn btn-secondary btn-block" id="predict-btn" type="submit" disabled>Predict</button>
        </div>
      </div>
    </div>

  

<!-- AI code - LEFT PANEL END -->

	
	
	

                 
                </div>
              </div><!-- /.card-body -->
            </div>
            <!-- /.card -->

            
      
          </section>
		  
		  
		            <section class="col-lg-6 connectedSortable">
            <!-- Custom tabs (Charts with tabs)-->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">
                  <i class="fas fa-chart-pie mr-1"></i>
                  YOLO Object Detection Results
                </h3>
				
                
              </div><!-- /.card-header -->
              <div class="card-body">
                <div class="tab-content p-0">
                  <!-- Morris chart - Sales -->
                  <div class="chart tab-pane active" id="revenue-chart"
                        style="position: relative; height: 700px;">
            
			<!-- AI code-->



<!-- Result display area (images, video, or webcam stream will be loaded here) -->
<div class="right-result-container" style="width:100%;">
  <!-- For images we reuse the img element. For server-generated video we'll swap in an img streaming from video_feed or an HTML5 video tag if desired. -->
  <img id="result-display" src="" alt="Detection result" style="max-width:100%; height:640px; display: none; object-fit: contain; border:1px solid #ddd;" />
  <img id="video-display" src="" alt="Video result" style="max-width:100%; height:640px; display: none; object-fit: contain; border:1px solid #ddd;" />
  <!-- Loading spinner shown while server is processing -->
  <div id="result-spinner" style="display:none; margin-top:16px;">
    <div class="spinner-border text-primary" role="status" style="width:3rem; height:3rem;">
      <span class="sr-only">Loading...</span>
    </div>
    <div id="spinner-text" style="margin-top:8px; font-weight:500;">Processing, please wait...</div>
  </div>
  <div style="margin-top:8px; text-align:center;">
    <button type="button" id="stop-btn" class="btn btn-danger btn-sm" style="display:none;">Close</button>
  </div>
</div>

<script>
// Show uploaded/processed image if provided by server
// server-provided processed image URL (empty string if none)
var server_image_url = {{ (image_url if image_url else '')|tojson }};
var server_video_present = {{ ('true' if video_present else 'false')|tojson }} === 'true';
var server_video_folder = {{ (video_folder if video_folder else '')|tojson }};
var server_video_stream_url = {{ (server_video_stream_url if server_video_stream_url else '')|tojson }};
function showUploadedResult() {
  if (server_image_url) {
    var img = document.getElementById('result-display');
    img.src = server_image_url;
    img.style.display = 'block';
    document.getElementById('stop-btn').style.display = 'inline-block';
    // hide spinner once result is ready
    var spinner = document.getElementById('result-spinner');
    if (spinner) spinner.style.display = 'none';
  }
  else if (server_video_present) {
    // show server-processed video: set src to video_feed with folder param so it reads the right file
    var vimg = document.getElementById('video-display');
    var feedUrl = "{{ url_for('video_feed') }}" + (server_video_folder ? "?folder=" + server_video_folder : "");
    vimg.src = feedUrl;
    vimg.style.display = 'block';
    document.getElementById('stop-btn').style.display = 'inline-block';
    var spinner = document.getElementById('result-spinner');
    if (spinner) spinner.style.display = 'none';
  }
  else if (server_video_stream_url) {
    // Show server-processed MJPEG stream for uploaded video (per-frame processing)
    var vimg = document.getElementById('video-display');
    vimg.src = server_video_stream_url;
    vimg.style.display = 'block';
    document.getElementById('stop-btn').style.display = 'inline-block';
    var spinner = document.getElementById('result-spinner');
    if (spinner) spinner.style.display = 'none';
  }
}

// Show webcam configuration modal
function showWebcamModal() {
  // For inline workflow: select webcam input and pre-select models from main selection (if any)
  var sel = document.querySelector('input[name="model"]:checked');
  var selectedModel = sel ? sel.value : 'yolov8n.pt';

  // Pre-select single/dual model radios to the chosen model where possible
  var singleRadio = document.querySelector('input[name="single_model"][value="' + selectedModel + '"]');
  if (singleRadio) singleRadio.checked = true;
  var d0 = document.querySelector('input[name="dual_model0"][value="' + selectedModel + '"]');
  if (d0) d0.checked = true;
  var d1 = document.querySelector('input[name="dual_model1"][value="' + selectedModel + '"]');
  if (d1) d1.checked = true;

  // Switch the inputType to webcam so webcam options become enabled
  var wb = document.getElementById('input-webcam');
  if (wb) { wb.checked = true; wb.dispatchEvent(new Event('change')); }

  // Scroll to webcam area for visibility
  var el = document.getElementById('webcam-options-area');
  if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

// Toggle dual camera options visibility
function toggleDualCameraOptions() {
  // Support legacy call and inline radio-driven mode.
  // If the user enabled the single-split checkbox, prefer showing the dual-model panels
  var splitCheckbox = document.getElementById('single_split_mode');
  var splitEnabled = splitCheckbox && splitCheckbox.checked;

  var modeRadio = document.querySelector('input[name="camera_mode"]:checked');
  var mode = modeRadio ? modeRadio.value : null;
  if (!mode) {
    // legacy fallback to select element
    var sel = document.getElementById('camera-mode-select');
    mode = sel ? sel.value : 'single';
  }

  if (splitEnabled) {
    // Show dual-model selectors so user can pick two models for the stacked single-camera view
    var s_hide = document.getElementById('webcam-models-single'); if (s_hide) s_hide.style.display = 'none';
    var d_show = document.getElementById('webcam-models-dual'); if (d_show) d_show.style.display = 'block';
    return;
  }

  if (mode === 'single') {
    var s = document.getElementById('webcam-models-single'); if (s) s.style.display = 'block';
    var d = document.getElementById('webcam-models-dual'); if (d) d.style.display = 'none';
  } else {
    var s2 = document.getElementById('webcam-models-single'); if (s2) s2.style.display = 'none';
    var d2 = document.getElementById('webcam-models-dual'); if (d2) d2.style.display = 'block';
  }
  // Enable the Start Webcam button if webcam input is selected
  var inputTypeWebcam = document.getElementById('input-webcam');
  if (inputTypeWebcam && inputTypeWebcam.checked) {
    var startBtn = document.getElementById('start-webcam-inline');
    if (startBtn) {
      startBtn.disabled = false;
      // ensure the button is visible inside the left panel (scroll to it)
      try { startBtn.scrollIntoView({ behavior: 'smooth', block: 'center' }); } catch(e){}
      // give a small attention highlight
      startBtn.style.boxShadow = '0 0 0.5rem rgba(220,53,69,0.25)';
      setTimeout(function(){ startBtn.style.boxShadow = ''; }, 1200);
    }
  }
}

// Start webcam based on selected configuration
function startSelectedWebcam() {
  // Read camera mode from radios (inline UI) or fallback to old select
  var modeRadio = document.querySelector('input[name="camera_mode"]:checked');
  var mode = modeRadio ? modeRadio.value : (document.getElementById('camera-mode-select') ? document.getElementById('camera-mode-select').value : 'single');
  var vimg = document.getElementById('video-display');
  var img = document.getElementById('result-display');
  var spinner = document.getElementById('result-spinner');
  var spinnerText = document.getElementById('spinner-text');

  // Do not rely on modal; just show spinner in the result area
  if (img) img.style.display = 'none';
  if (vimg) vimg.style.display = 'none';
  if (spinner) {
    spinner.style.display = 'block';
    if (spinnerText) {
      spinnerText.textContent = mode === 'single' ? 'Initializing camera and loading model...' : 'Initializing cameras and loading models...';
    }
  }

  // Helper to choose camera index then start stream
  function chooseCameraAndStart(startFn) {
    fetch('{{ url_for("list_cameras") }}').then(function(r){ return r.json(); }).then(function(data){
      var cams = (data && data.cameras) ? data.cameras : [];
      if (cams.length > 1) {
        // show modal to pick index
        var list = document.getElementById('camera-index-list');
        list.innerHTML = '';
        cams.forEach(function(ci){
          var id = 'cam_radio_' + ci;
          var div = document.createElement('div');
          div.className = 'form-check';
          div.innerHTML = '<input class="form-check-input" type="radio" name="cam_index" id="'+id+'" value="'+ci+'">'
                        + '<label class="form-check-label small" for="'+id+'">Camera '+ci+'</label>';
          list.appendChild(div);
        });
        // pre-select first
        var first = list.querySelector('input[name="cam_index"]'); if (first) first.checked = true;
        var modal = document.getElementById('camera-index-modal');
        modal.style.display = 'block';
        document.getElementById('camera-index-choose').onclick = function(){
          var sel = document.querySelector('input[name="cam_index"]:checked');
          var idx = sel ? sel.value : cams[0];
          modal.style.display = 'none';
          startFn(parseInt(idx,10));
        };
        document.getElementById('camera-index-cancel').onclick = function(){ modal.style.display = 'none'; };
      } else {
        // single or none -> default to 0 or detected
        var idx = cams.length === 1 ? cams[0] : 0;
        startFn(idx);
      }
    }).catch(function(){ startFn(0); });
  }

  // Set up the webcam stream URL based on selected inline radio models
  if (mode === 'single') {
    // Check if user wants to process the single camera with two models (stacked)
    var singleSplitCheckbox = document.getElementById('single_split_mode');
    var isSplit = singleSplitCheckbox && singleSplitCheckbox.checked;
    if (isSplit) {
      var m0 = document.querySelector('input[name="dual_model0"]:checked');
      var m1 = document.querySelector('input[name="dual_model1"]:checked');
      var model0 = m0 ? m0.value : 'yolov8n.pt';
      var model1 = m1 ? m1.value : 'yolov8n.pt';
      chooseCameraAndStart(function(camIndex){
        vimg.src = "{{ url_for('webcam_feed_split') }}?model0=" + encodeURIComponent(model0) + "&model1=" + encodeURIComponent(model1) + "&cam=" + encodeURIComponent(camIndex);
      });
    } else {
      var selModel = document.querySelector('input[name="single_model"]:checked');
      var model = selModel ? selModel.value : 'yolov8n.pt';
      chooseCameraAndStart(function(camIndex){
        vimg.src = "{{ url_for('webcam_feed') }}?model=" + encodeURIComponent(model) + "&cam=" + encodeURIComponent(camIndex);
      });
    }
  } else {
    var m0 = document.querySelector('input[name="dual_model0"]:checked');
    var m1 = document.querySelector('input[name="dual_model1"]:checked');
    var model0 = m0 ? m0.value : 'yolov8n.pt';
    var model1 = m1 ? m1.value : 'yolov8n.pt';
    vimg.src = "{{ url_for('webcam_feed_dual') }}?model0=" + encodeURIComponent(model0) + "&model1=" + encodeURIComponent(model1);
  }
  
  // Show video display and hide spinner once stream starts loading
  vimg.onload = function() {
    if (spinner) spinner.style.display = 'none';
    vimg.style.display = 'block';
    document.getElementById('stop-btn').style.display = 'inline-block';
  };
  
  // For MJPEG streams, onload may not fire, so use a timeout fallback
  setTimeout(function() {
    if (spinner && spinner.style.display !== 'none') {
      spinner.style.display = 'none';
      vimg.style.display = 'block';
      document.getElementById('stop-btn').style.display = 'inline-block';
    }
  }, 5000); // Show video after 5 seconds to account for model loading + camera init
}

// Start webcam stream into the result area (kept for backward compatibility)
function startWebcam() {
  showWebcamModal();
}

// Stop any stream and clear the result area (works for image, processed video or webcam)
function stopStream() {
  var img = document.getElementById('result-display');
  var vimg = document.getElementById('video-display');
  var spinner = document.getElementById('result-spinner');
  var spinnerText = document.getElementById('spinner-text');
  
  // Clearing src should close MJPEG connections in most browsers
  try { img.src = ''; } catch(e) {}
  try { vimg.src = ''; } catch(e) {}
  img.style.display = 'none';
  vimg.style.display = 'none';
  document.getElementById('stop-btn').style.display = 'none';
  
  // Hide spinner and reset text
  if (spinner) spinner.style.display = 'none';
  if (spinnerText) spinnerText.textContent = 'Processing, please wait...';
}

document.getElementById('stop-btn').addEventListener('click', function(e){
  // Prevent default (in case button resides in a form) so it doesn't submit and reload the page
  try { e.preventDefault(); } catch(err){}
  // Close button: only stop the stream / clear outputs. Do not navigate to Home.
  stopStream();
});

// If the server provided a processed image path, show it on load
window.addEventListener('load', function(){
  showUploadedResult();
  // If server returned a processed result, show the Detection dashboard so the user sees results immediately.
  try {
    var hasImage = (typeof server_image_url !== 'undefined' && server_image_url);
    var hasVideo = (typeof server_video_present !== 'undefined' && server_video_present === true);
    var hasStream = (typeof server_video_stream_url !== 'undefined' && server_video_stream_url);
    if (hasImage || hasVideo || hasStream) {
      showDetectionView();
    } else {
      showHomeView();
    }
  } catch(e) { try { showHomeView(); } catch(err){} }
});

// Navigation and Tasks wiring: show/hide home and detection views
function showHomeView(){
  var home = document.getElementById('home-view');
  var det = document.getElementById('detection-dashboard');
  if (home) home.style.display = 'block';
  if (det) det.style.display = 'none';
}

function showDetectionView(){
  var home = document.getElementById('home-view');
  var det = document.getElementById('detection-dashboard');
  if (home) home.style.display = 'none';
  if (det) det.style.display = 'block';
  // scroll to top of detection area
  try { window.scrollTo({ top: 0, behavior: 'smooth' }); } catch(e){}
}

function showContactView(){
  var home = document.getElementById('home-view');
  var det = document.getElementById('detection-dashboard');
  var contact = document.getElementById('contact-view');
  if (home) home.style.display = 'none';
  if (det) det.style.display = 'none';
  if (contact) contact.style.display = 'block';
  try { window.scrollTo({ top: 0, behavior: 'smooth' }); } catch(e){}
}

function showUnavailable(task){
  var home = document.getElementById('home-view');
  var det = document.getElementById('detection-dashboard');
  var content = document.getElementById('detection-content');
  var ua = document.getElementById('task-unavailable');
  if (home) home.style.display = 'none';
  if (det) det.style.display = 'block';
  if (content) content.style.display = 'none';
  if (ua) {
    var name = task || '';
    var label = document.getElementById('unavailable-task-name');
    if (label) label.textContent = name.charAt(0).toUpperCase() + name.slice(1);
    ua.style.display = 'block';
  }
}

function hideUnavailable(){
  var content = document.getElementById('detection-content');
  var ua = document.getElementById('task-unavailable');
  if (ua) ua.style.display = 'none';
  if (content) content.style.display = 'block';
}

// Wire nav links and task radio buttons after DOM is ready
document.addEventListener('DOMContentLoaded', function(){
  var homeLink = document.getElementById('nav-home');
  var contactLink = document.getElementById('nav-contact');
  if (homeLink) homeLink.addEventListener('click', function(e){ e.preventDefault(); showHomeView(); });
  if (contactLink) contactLink.addEventListener('click', function(e){ e.preventDefault(); showContactView(); });

  // Task radio selection: show detection dashboard when object detection selected
    var taskRadios = document.querySelectorAll('input[name="taskOption"]');
    taskRadios.forEach(function(r){ r.addEventListener('change', function(){
        if (!this.checked) return;
        if (this.value === 'detection') {
          hideUnavailable();
          showDetectionView();
        } else {
          // show unavailable message for other tasks
          showUnavailable(this.value);
        }
    }); });

    // Wire unavailable OK button
    var okBtn = document.getElementById('unavailable-ok');
    if (okBtn) okBtn.addEventListener('click', function(){ hideUnavailable(); showHomeView(); });
});

// Show spinner when user submits the predict form
document.getElementById('predict-form').addEventListener('submit', function(e){
  // clear previous results
  try { document.getElementById('result-display').src = ''; } catch(e) {}
  try { document.getElementById('video-display').src = ''; } catch(e) {}
  document.getElementById('result-display').style.display = 'none';
  document.getElementById('video-display').style.display = 'none';
  // show spinner
  var spinner = document.getElementById('result-spinner');
  if (spinner) spinner.style.display = 'block';
});

// Inline UI wiring: enable/disable controls based on selections
(function(){
  // inputType radios
  var inputRadios = document.querySelectorAll('input[name="inputType"]');
  inputRadios.forEach(function(r){ r.addEventListener('change', function(){
    var val = document.querySelector('input[name="inputType"]:checked').value;
    if (val === 'image' || val === 'video'){
      document.getElementById('inputfile').disabled = false;
      document.getElementById('predict-btn').disabled = true; // enabled when file selected
      document.getElementById('start-webcam-inline').disabled = true;
    } else if (val === 'webcam'){
      document.getElementById('inputfile').disabled = true;
      document.getElementById('inputfile').value = '';
      document.getElementById('predict-btn').disabled = true;
      document.getElementById('start-webcam-inline').disabled = false;
    }
  }); });

  // file input change -> enable Predict
  var fileInput = document.getElementById('inputfile');
    if (fileInput){
    fileInput.addEventListener('change', function(){
      var btn = document.getElementById('predict-btn');
      if (this.files && this.files.length > 0){ 
        btn.disabled = false; 
        // Make the button visually prominent when enabled
        btn.classList.remove('btn-secondary');
        btn.classList.add('btn-danger');
        btn.textContent = 'Detect';
        // bring button into view
        try { btn.scrollIntoView({behavior:'smooth', block:'center'}); } catch(e){}
      }
      else { 
        btn.disabled = true; 
        btn.classList.remove('btn-danger');
        btn.classList.add('btn-secondary');
        btn.textContent = 'Predict';
      }
    });
  }

  // camera mode change -> show/hide dual panels
  var camRadios = document.querySelectorAll('input[name="camera_mode"]');
  camRadios.forEach(function(r){ r.addEventListener('change', function(){ toggleDualCameraOptions(); }); });

  // When user toggles the single-split checkbox, show the dual-model selectors so they can pick two models
  var splitCheckbox = document.getElementById('single_split_mode');
  if (splitCheckbox) {
    splitCheckbox.addEventListener('change', function(){
      var dual = document.getElementById('webcam-models-dual');
      var single = document.getElementById('webcam-models-single');
      if (this.checked) {
        if (dual) dual.style.display = 'block';
        if (single) single.style.display = 'none';
        // ensure at least one radio is checked for both dual_model0 and dual_model1
        var a = document.querySelector('input[name="dual_model0"]:checked');
        if (!a) { var first = document.querySelector('input[name="dual_model0"]'); if (first) first.checked = true; }
        var b = document.querySelector('input[name="dual_model1"]:checked');
        if (!b) { var first2 = document.querySelector('input[name="dual_model1"]'); if (first2) first2.checked = true; }
      } else {
        if (dual) dual.style.display = 'none';
        if (single) single.style.display = 'block';
      }
    });
  }

  // single-split checkbox -> show dual-model selectors even when camera mode is single
  var singleSplit = document.getElementById('single_split_mode');
  if (singleSplit) {
    singleSplit.addEventListener('change', function(){
      // When enabling split mode, ensure webcam input is selected so Start Webcam is available
      try { document.getElementById('input-webcam').checked = true; } catch(e){}
      toggleDualCameraOptions();
    });
  }

  // Upload model button handler (AJAX)
  var uploadBtn = document.getElementById('upload-model-submit');
  if (uploadBtn){
    uploadBtn.addEventListener('click', function(){
      if(!document.getElementById('disclaimer_inline').checked){ alert('Please confirm you have the rights to upload this model.'); return; }
      var file = document.getElementById('model_file');
      if(!file || !file.files || file.files.length===0){ alert('Please select a .pt model file to upload.'); return; }
      var fd = new FormData();
      fd.append('model_file', file.files[0]);
      fd.append('model_name', document.getElementById('model_name').value || '');
      fd.append('disclaimer', document.getElementById('disclaimer_inline').checked ? 'on' : '');
      uploadBtn.disabled = true; uploadBtn.textContent = 'Uploading...';
      fetch('/upload_model', { method: 'POST', body: fd }).then(function(r){ return r.text(); }).then(function(){ location.reload(); }).catch(function(err){ alert('Upload failed: '+err); uploadBtn.disabled=false; uploadBtn.textContent='Upload'; });
    });
  }
  // Wire Start Webcam inline button to existing startSelectedWebcam function
  var startInline = document.getElementById('start-webcam-inline');
  if (startInline) startInline.addEventListener('click', function(){ startSelectedWebcam(); });

})();
</script>


<!-- AI code ends here-->		

                    </div>
                 
                </div>
              </div><!-- /.card-body -->
            </div>
            <!-- /.card -->

            
      
          </section>
		  
		  
		  
          <!-- /.Left col -->
          <!-- right col (We are only adding the ID to make the widgets sortable)-->

          <!-- right col -->
  </div>
  </div> <!-- /#detection-content -->
  </div>
  </div> <!-- /#detection-dashboard -->
        <!-- /.row (main row) -->
      </div><!-- /.container-fluid -->
    </section>
    <!-- /.content -->

  </div>

{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}

  <!-- jQuery -->
  <script src="/static/assets/plugins/jquery/jquery.min.js"></script>
  <!-- jQuery UI 1.11.4 -->
  <script src="/static/assets/plugins/jquery-ui/jquery-ui.min.js"></script>
  <!-- Resolve conflict in jQuery UI tooltip with Bootstrap tooltip -->
  <script>
    $.widget.bridge('uibutton', $.ui.button)
  </script>
  <!-- Bootstrap 4 -->
  <script src="/static/assets/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
  <!-- ChartJS -->
  <script src="/static/assets/plugins/chart.js/Chart.min.js"></script>
  <!-- Sparkline -->
  <script src="/static/assets/plugins/sparklines/sparkline.js"></script>
  <!-- JQVMap -->
  <script src="/static/assets/plugins/jqvmap/jquery.vmap.min.js"></script>
  <script src="/static/assets/plugins/jqvmap/maps/jquery.vmap.usa.js"></script>
  <!-- jQuery Knob Chart -->
  <script src="/static/assets/plugins/jquery-knob/jquery.knob.min.js"></script>
  <!-- daterangepicker -->
  <script src="/static/assets/plugins/moment/moment.min.js"></script>
  <script src="/static/assets/plugins/daterangepicker/daterangepicker.js"></script>
  <!-- Tempusdominus Bootstrap 4 -->
  <script src="/static/assets/plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js"></script>
  <!-- Summernote -->
  <script src="/static/assets/plugins/summernote/summernote-bs4.min.js"></script>
  <!-- overlayScrollbars -->
  <script src="/static/assets/plugins/overlayScrollbars/js/jquery.overlayScrollbars.min.js"></script>
  <!-- AdminLTE App -->
  <script src="/static/assets/js/adminlte.js"></script>
  <!-- AdminLTE dashboard demo (This is only for demo purposes) -->
  <script src="/static/assets/js/pages/dashboard.js"></script>
  <!-- AdminLTE for demo purposes -->
  <script src="/static/assets/js/demo.js"></script>
  <!-- Intro.js library -->
  <script src="https://unpkg.com/intro.js/minified/intro.min.js"></script>

  <script>
    // Guided tour: show prompt if user hasn't seen the tour or if forced by URL (?tour=1)
    (function(){
      function onReady(fn){ if (document.readyState !== 'loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
      onReady(function(){
        try {
          var seen = localStorage.getItem('dashboard_tour_seen');
          var prompt = document.getElementById('tour-prompt');
          var startBtn = document.getElementById('tour-start');
          var skipBtn = document.getElementById('tour-skip');
          var helpBtn = document.getElementById('tour-help-btn');
          var toast = document.getElementById('tour-toast');
          var toastStart = document.getElementById('tour-toast-start');
          var toastDismiss = document.getElementById('tour-toast-dismiss');

          // check URL param 'tour=1' to force display
          var urlParams = new URLSearchParams(window.location.search);
          var force = urlParams.get('tour') === '1';

          if ((!seen && prompt) || force){
            // show prompt after short delay
            setTimeout(function(){ if (prompt) prompt.style.display = 'block'; }, 500);
          } else if (seen && !localStorage.getItem('dashboard_tour_skipped')){
            // user previously saw tour — show a gentle toast reminder for a short time
            if (toast){ toast.style.display = 'block'; setTimeout(function(){ try{ toast.style.display='none'; }catch(e){} }, 15000); }
          }

          function markSeen(){ localStorage.setItem('dashboard_tour_seen', '1'); if (prompt) prompt.style.display='none'; }

          function startTour(){
            markSeen();
            var candidateSteps = [
              { selector: '#model-list', text: 'Step 1: Choose a model from the visible list or upload a custom .pt model.', position: 'bottom' },
              { selector: '#model_file', text: 'You can upload a custom .pt model here (it is loaded into memory only).', position: 'bottom' },
              { selector: '#input-image', text: 'Step 2: Select the input type: Image, Video, or Webcam.', position: 'bottom' },
              { selector: '#file-input-area', text: 'If you selected Image or Video, pick a file here and press predict buttom.', position: 'bottom' },
              { selector: '#webcam-options-area', text: 'If Webcam is selected, choose single or dual camera and per-camera models here.', position: 'bottom' },
              { selector: '#start-webcam-inline', text: 'Start the webcam stream inline on the right side.', position: 'bottom' },
              { selector: '#predict-btn', text: 'Click Detect to run the selected model on the uploaded file.', position: 'bottom' },
              { selector: '#result-display', text: 'Results (images/videos/streams) show here on the right.', position: 'top' }
            ];

            var steps = [];
            candidateSteps.forEach(function(s){
              try {
                var el = document.querySelector(s.selector);
                // If element exists but is hidden (display:none), try to use a visible right-side container
                var isVisible = el && el.offsetParent !== null && window.getComputedStyle(el).display !== 'none' && window.getComputedStyle(el).visibility !== 'hidden';
                if (el && isVisible) {
                  steps.push({ element: el, intro: s.text, position: s.position });
                } else if (s.selector === '#result-display') {
                  // prefer the right-result container as anchor for the results step
                  var alt = document.querySelector('.right-result-container');
                  if (alt) {
                    steps.push({ element: alt, intro: s.text, position: 'left' });
                  } else {
                    steps.push({ intro: s.text });
                  }
                } else if (el && !isVisible) {
                  // element present but hidden: show a center step instead so the user still sees guidance
                  steps.push({ intro: s.text });
                } else {
                  // element not present: add a center step showing the text so the flow continues
                  steps.push({ intro: s.text });
                }
              } catch(e){ steps.push({ intro: s.text }); }
            });

            // Hide the built-in skip button and label — we provide our own prompt controls
            introJs().setOptions({ steps: steps, showProgress: true, exitOnOverlayClick: false, showBullets: false, nextLabel:'Next', prevLabel:'Back', doneLabel:'Done', skipLabel:'', showSkipButton: false }).start();
          }

          if (startBtn){ startBtn.addEventListener('click', startTour); }
          if (skipBtn){ skipBtn.addEventListener('click', markSeen); }
          if (helpBtn){ helpBtn.addEventListener('click', function(){ startTour(); }); }
          if (toastStart){ toastStart.addEventListener('click', function(){ startTour(); if (toast) toast.style.display='none'; }); }
          if (toastDismiss){ toastDismiss.addEventListener('click', function(){ if (toast) toast.style.display='none'; localStorage.setItem('dashboard_tour_skipped','1'); }); }
        } catch (e){ console.warn('Tour init failed', e); }
      });
    })();
  </script>

{% endblock javascripts %}
